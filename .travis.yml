---
language: minimal

services:
- docker

stages:
- Build and Test
- Github Release
- Docker Release

jobs:
  include:
    - stage: Build and Test
      name: Build
      language: go
      go: 1.14.x
      script: make build
    - name: Unit tests
      language: go
      go: 1.14.x
      script: make unit-test
    - name: Go report card test
      script: make go-report-card-test
    - name: Readme length validator
      script: make validate-readme
    - name: License test
      if: type = push AND env(GITHUB_TOKEN) IS present
      script: make license-test
    - name: Helm lint test
      script: make helm-lint-test
    - name: AEMM E2E tests
      language: go
      go: 1.14.x
      script: make e2e-test
    - name: Build Github release assets
      if: env(GITHUB_TOKEN) IS present
      script: make build-release-assets
    - name: Build Docker images
      if: env(DOCKERHUB_TOKEN) IS present
      script: make build-docker-images
    - stage: Github Release
      name: Github release
      if: type = push AND tag =~ /^v\d+\.\d+(\.\d+)?(-\S*)?$/ AND env(GITHUB_TOKEN) IS present
      script: make release
    - stage: Docker Release
      name: Docker release
      if: type = push AND tag =~ /^v\d+\.\d+(\.\d+)?(-\S*)?$/ AND env(DOCKERHUB_TOKEN) IS present
      script: make release-docker
